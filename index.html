<html>
	<head>
	<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="jquery.spritely.js"></script>
	<script src="jquery.backgroundPosition.js"></script>

		<title>Slot Machine</title>
		<link href='http://fonts.googleapis.com/css?family=Iceland' rel='stylesheet' type='text/css'>
		<style type="text/css">
		 * {
			-webkit-user-select:none;
			-webkit-touch-callout:none;
			-webkit-user-drag:none;
			}

		 body,html { height:100%; margin:0px; overflow:hidden; font-weight:normal; font-family:iceland,verdana;}
		 body { margin:0px; overflow:hidden; }
		 #spin-btn { width:100%; position:absolute; bottom:15;left:0%;text-align:center; z-index:999; }
		 #frame {
			 margin:0px;
			 background:url(frame.png) no-repeat; 
			 background-size:100%; 
			 background-position:center 0;
			 height:100%;
			 width:100%;
			 position:absolute;
			 top:0; 
			 z-index:800;
		 }
		 #wheels {
			 position:absolute;
			 margin:auto;
			 top:27%;
			 height:140px;
			 width:100%;
			 
		 }
		 #result { position:absolute; top:0; width:100%; text-align:center; font-size:1.2em; }
		 #wheels ul { list-style:none; margin:0px auto 0px auto; padding:0px;}
		 #wheels li {
			-webkit-transition: -webkit-transform .8s ease-in-out; 
			margin:auto;
			padding:0px;
			display:inline-block;
			list-style:none;
			width:32%;
			height:150px;
			color:pink;
			text-align:center;
		 }
		 #leds { -webkit-transition: -webkit-transform .2s ease-in-out;  background:url(leds.png) no-repeat; height:28px; position:absolute; z-index:9999; bottom:-19px; width:100%; background-position:center -28px; margin:0 auto;} 
		 #leds.on { background-position:center 0px; }
		 #spin-btn { margin:auto; text-align:center; }
		 #score-board { z-index:998;position:relative;width:92%; padding:20px 10px 10px 10px;margin:0px auto;font-size:2em;color:#fd15ea;}
		 #score-board div { display:inline-block; width:33%; padding-top:10px;text-align:center;}
		 #control {
		    -webkit-tap-highlight-color: rgba(0,0,0,0);
			margin:auto;
			width:274px;
			text-indent:-9999px;
			height:100px;		
			display:block;
		 }
		 .start { 			background:url(btn.png) no-repeat; background-position:center 0px; }
		 .start.pressed {  	background:url(btn.png) no-repeat; background-position:center -100px; }
		 .stop {  			background:url(btn.png) no-repeat; background-position:center -200px; }
		 .stop.pressed {  	background:url(btn.png) no-repeat; background-position:center -300px; }
		 .reset {  			background:url(btn.png) no-repeat; background-position:center -400px; }		 
		 .reset.pressed {  	background:url(btn.png) no-repeat; background-position:center -500px; }

		 .slot { background:#fff  url(bars.png); background-position:0 4px;background-size:100%; }
		 .motion {
		    background:#fff url(bars-blur.png);
			background-size:100%;
		 }

		 
		</style>
		<script>

$(document).ready(function() {
	window.scroll(0,1);
	var debug='';
	if (!debug) {
	 var spinSnd = new Audio("spin.mp3"); // buffers automatically when created
	  spinSnd.addEventListener('ended', function() {
      this.currentTime = 0;
      this.play();
	}, false);

	 var stopSnd = new Audio("stop.mp3"); // buffers automatically when created
	 var winSnd = new Audio("win.mp3"); // buffers automatically when created
	}

	$('#control').bind('touchstart',function() {
		if ( winner == 0 ) {
		 $(this).addClass('pressed'); 
		}
	});
	$('#control').bind('touchend',function() {
		if ( winner == 0 ) {
		 $(this).removeClass('pressed');
		}
	});


	var winner    = 0,
		credits   =100,
		score     =0,
		bet       =1,
	    completed = 0,
		imgHeight = 1200,
		posArr = [
			0, //cc
			150, //nfc
			300, //isis
			450, //phone
			600, //cc
			750, // nfc
			900, // isis
			1050 // phone
		];
	
	var win = [];
	win[0]   = win[0]   = win[0]   = 1;
	win[150] = win[150] = win[150] = 2;
	win[300] = win[300] = win[300] = 3;
	win[450] = win[450] = win[450] = 4;
	win[600] = win[600] = win[600] = 5;
	win[750] = win[750] = win[750] = 6;
	win[900] = win[900] = win[900] = 7;
	win[1050] = win[1050] = win[1050] = 8;
	/**
	* @class Slot
	* @constructor
	*/
	function Slot(el, max, step) {
	
		this.speed = 0; //speed of the slot at any point of time
		this.step = step; //speed will increase at this rate
		this.si = null; //holds setInterval object for the given slot
		this.el = el; //dom element of the slot
		this.maxSpeed = max; //max speed this slot can have
		this.pos = null; //final position of the slot	

		$(el).pan({
            fps:30,
            dir:'down'
        });
		$(el).spStop();
	}

	/**
	* @method start
	* Starts a slot
	*/
	Slot.prototype.start = function() {
		var _this = this;

		$(_this.el).addClass('motion');
        $(_this.el).spStart();
		_this.si = window.setInterval(function() {
			if(_this.speed < _this.maxSpeed) {
				_this.speed += _this.step;
				$(_this.el).spSpeed(_this.speed);
			}
		}, 100);
	};

	/**
	* @method stop
	* Stops a slot
	*/
	Slot.prototype.stop = function() {

		var _this = this,
			limit = 30;
		clearInterval(_this.si);
		_this.si = window.setInterval(function() {
			if(_this.speed > limit) {
				_this.speed -= _this.step;
				$(_this.el).spSpeed(_this.speed);
			}
			if(_this.speed <= limit) {
	
				_this.finalPos(_this.el);
			
				$(_this.el).spSpeed(0);
				$(_this.el).spStop();
				clearInterval(_this.si);
				$(_this.el).removeClass('motion');
				_this.speed = 0;
			}
		}, 100);
	};

	/**
	* @method finalPos
	* Finds the final position of the slot
	*/
	Slot.prototype.finalPos = function() {
		var el = this.el,
			el_id,
			pos,
			posMin = 2000000000,
			best,
			bgPos,
			i,
			j,
			k;

		el_id = $(el).attr('id');

		  pos = document.getElementById(el_id).style.backgroundPosition;
		  pos = pos.split(' ')[1];
		  pos = parseInt(pos, 10);
		
		
		for(i = 0; i < posArr.length; i++) {
			for(j = 0;;j++) {
				k = posArr[i] + (imgHeight * j);
				if(k > pos) {
					if((k - pos) < posMin) {
						posMin = k - pos;
						best = k;
						this.pos = posArr[i]; 
					}
					break;
				}
			}
		}

		best += imgHeight + 4;
		
		if (winner==1){ 
		  bgPos = "0 " + 590 + "px";
		} else {
		  bgPos = "0 " + best + "px";	  
		}
		  console.log(bgPos);
		stopSnd.currentTime=0;
		$(el).animate({
			backgroundPosition:"(" + bgPos + ")"
		}, {
			duration: 200,
			complete: function() {
			console.log(bgPos);	   
				completed ++;
				console.log(completed);
				stopSnd.play();	
            }
		});
	};
	
	/**
	* @method reset
	* Reset a slot to initial state
	*/
	Slot.prototype.reset = function() {
		var el_id = $(this.el).attr('id');
        $._spritely.instances[el_id].t = 0;
		$(this.el).css('background-position', '0px 4px');
		this.speed = 0;
		completed = 0;

	};

	function printResult() {

		if(win[a.pos] === win[b.pos] && win[a.pos] === win[c.pos]) {

			score=(score+bet*win[a.pos]);//*win;
			$("#score").html(score);
		
		}
	}

	var a = new Slot('#slot1', 30, 1),
		b = new Slot('#slot2', 45, 2),
		c = new Slot('#slot3', 70, 3);

	/**
	* Slot machine controller
	*/
	$('#control').click(function() {
		var x;

		 if(this.innerHTML == "Start") {
		 	if (winner ==1 ) { // do nothing 
			} else {
				a.start();
				b.start();
				c.start();
				credits=credits-bet;
				$("#credits").html(credits);
				this.innerHTML = "Stop";
				$(this).toggleClass('start'); 
				$(this).toggleClass('stop'); 
				
				spinSnd.play();
				
				winnerData = $.getJSON('app/game/', function(data) {
					winner = data.winner; 

				});

				
				x = window.setInterval(function() {
					if(a.speed >= a.maxSpeed && b.speed >= b.maxSpeed && c.speed >= c.maxSpeed) {
						window.clearInterval(x);
					}
				}, 100);
			}
		 } else if(this.innerHTML == "Stop") {
			a.stop();
			b.stop();
			c.stop();


			$(this).toggleClass('reset');
			spinSnd.currentTime=0;
			spinSnd.pause();
            this.innerHTML="reset";

            x = window.setInterval(function() {
                if(a.speed === 0 && b.speed === 0 && c.speed === 0 && completed === 3) {
                    window.clearInterval(x);
					if(winner==1){
					 winSnd.play();
					 $("#leds").fadeIn(200, function(){ $("#leds").toggleClass('on'); } ).fadeOut(200, function(){ $("#leds").toggleClass('on'); } ).fadeIn(200, function(){ $("#leds").toggleClass('on'); } ).fadeOut(200, function(){ $("#leds").toggleClass('on'); } ).fadeIn(200, function(){ $("#leds").toggleClass('on'); } ).fadeOut(200, function(){ $("#leds").toggleClass('on'); } ).fadeIn(200, function(){ $("#leds").toggleClass('on'); } ).fadeOut(200, function(){ $("#leds").toggleClass('on'); } ).fadeIn(200, function(){ $("#leds").toggleClass('on'); } ).fadeOut(200, function(){ $("#leds").toggleClass('on'); } ).fadeIn(200, function(){ $("#leds").toggleClass('on'); } ).fadeOut(200, function(){ $("#leds").toggleClass('on'); } ).fadeIn(200, function(){ $("#leds").toggleClass('on'); } ).fadeOut(200, function(){ $("#leds").toggleClass('on'); } ).fadeIn(200, function(){ $("#leds").toggleClass('on'); } ).fadeOut(200, function(){ $("#leds").toggleClass('on'); } ).fadeIn(200, function(){ $("#leds").toggleClass('on'); } ).fadeOut(200, function(){ $("#leds").toggleClass('on'); } ).fadeIn(200, function(){ $("#leds").toggleClass('on'); } ).fadeOut(200, function(){ $("#leds").toggleClass('on'); } ).fadeIn(200, function(){ $("#leds").toggleClass('on'); } ).fadeOut(200, function(){ $("#leds").toggleClass('on'); } ).fadeIn(200, function(){ $("#leds").toggleClass('on'); } ).fadeOut(200, function(){ $("#leds").toggleClass('on'); } ).fadeIn(200, function(){ $("#leds").toggleClass('on'); } ).toggleClass('on');
					}
					printResult();
					
					
                }
            }, 100);
		} else { //reset
				credits=credits+score;
				score=0;
				$("#credits").html(credits);
				$("#score").html(score);
				a.reset();
				b.reset();
				c.reset();
				this.innerHTML = "Start";
				$(this).toggleClass('start');
				$(this).toggleClass('stop'); 
				$(this).toggleClass('reset'); 
		}
	});
});
		</script>
	</head>
	<body>
	
	<div id="spin-btn">
		<a href="#" id="control" class="start">Start</a>
	</div>

	<div id="frame"></div>
		<div id="wheels">
			<div id="leds"></div>
			<ul>
				<li id="slot1" class="slot"></li>
				<li id="slot2" class="slot"></li>
				<li id="slot3" class="slot"></li>
			</ul>
		
		<div id="score-board">
		  <div id="result"></div>
		  <div id="credits">100</div><div id="score">0</div><div id="bet">1</div>
		</div>
	
	</div>
	
	</body>
</html>
